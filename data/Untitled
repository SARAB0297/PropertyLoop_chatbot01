from pathlib import Path
from typing import Tuple

import pandas as pd

from data.schema import (
    HOLDINGS_REQUIRED_COLUMNS,
    TRADES_REQUIRED_COLUMNS,
)


class DataLoaderError(Exception):
    pass


class SchemaValidationError(DataLoaderError):
    pass


class CSVNotFoundError(DataLoaderError):
    pass


class DataLoader:
    """
    Loads and validates holdings and trades CSV files.
    This class is designed to be instantiated ONCE
    and reused across the application lifecycle.
    """

    def __init__(self, data_dir: str):
        self.data_dir = Path(data_dir)
        self._holdings_df: pd.DataFrame | None = None
        self._trades_df: pd.DataFrame | None = None

    def load(self) -> None:
        """
        Load and validate both holdings and trades data.
        """
        self._holdings_df = self._load_csv(
            filename="holdings.csv",
            required_columns=HOLDINGS_REQUIRED_COLUMNS
        )

        self._trades_df = self._load_csv(
            filename="trades.csv",
            required_columns=TRADES_REQUIRED_COLUMNS
        )

    def _load_csv(self, filename: str, required_columns: list) -> pd.DataFrame:
        """
        Internal helper to load and validate a CSV file.
        """
        file_path = self.data_dir / filename

        if not file_path.exists():
            raise CSVNotFoundError(f"CSV file not found: {file_path}")

        df = pd.read_csv(file_path)

        missing_columns = set(required_columns) - set(df.columns)
        if missing_columns:
            raise SchemaValidationError(
                f"{filename} is missing required columns: {missing_columns}"
            )

        return df

    @property
    def holdings(self) -> pd.DataFrame:
        """
        Safe accessor for holdings data.
        """
        if self._holdings_df is None:
            raise DataLoaderError("Holdings data not loaded.")
        return self._holdings_df

    @property
    def trades(self) -> pd.DataFrame:
        """
        Safe accessor for trades data.
        """
        if self._trades_df is None:
            raise DataLoaderError("Trades data not loaded.")
        return self._trades_df
